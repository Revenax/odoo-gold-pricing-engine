<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_invoice_document_gold" inherit_id="account.report_invoice_document">

    <!-- Inject custom styles and column visibility flags before main content -->
    <xpath expr="//div[contains(@class, 'page') and contains(@class, 'mb-4')]" position="before">
        <style><![CDATA[
            th {
                font-weight: 900;
                font-size: 14px;
            }
            td {
                font-size: 14px;
            }
        ]]></style>
        <t t-set="report_product_lines" t-value="o.invoice_line_ids.filtered(lambda l: l.display_type not in ('line_section', 'line_note', 'rounding'))"/>
        <t t-set="report_show_jewellery_type" t-value="any(l.jewellery_type for l in report_product_lines)"/>
        <t t-set="report_show_karat" t-value="any(l.gold_purity or l.diamond_karat or l.silver_purity for l in report_product_lines)"/>
        <t t-set="report_show_weight" t-value="any(l.jewellery_weight_g or l.gold_weight_g for l in report_product_lines)"/>
        <t t-set="report_show_quantity" t-value="any(l.quantity != 1 for l in report_product_lines)"/>
        <t t-set="report_show_unit_price" t-value="report_show_quantity"/>
    </xpath>

    <!-- Complete header deletion -->
        <xpath expr="//div[contains(@class, 'row')]" position="replace" />

        <!-- Our custom doc title -->
        <xpath expr="//div[contains(@class, 'page') and contains(@class, 'mb-4')]/h2" position="replace">
            <span style="margin-bottom: 10px; margin-top: 200px;">
                <center>
                <br/>
                <br/>
                <br/>
                    <span t-if="not proforma"></span>
                    <span t-else="">PROFORMA</span>
                    <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">Invoice</span>
                    <span t-elif="o.move_type == 'out_invoice' and o.state == 'draft'">Draft Invoice</span>
                    <span t-elif="o.move_type == 'out_invoice' and o.state == 'cancel'">Cancelled Invoice</span>
                    <span t-elif="o.move_type == 'out_refund' and o.state == 'posted'">Credit Note</span>
                    <span t-elif="o.move_type == 'out_refund' and o.state == 'draft'">Draft Credit Note</span>
                    <span t-elif="o.move_type == 'out_refund' and o.state == 'cancel'">Cancelled Credit Note</span>
                    <span t-elif="o.move_type == 'in_refund'">Vendor Credit Note</span>
                    <span t-elif="o.move_type == 'in_invoice'">Vendor Bill</span>
                    <span t-if="o.name != '/'" t-field="o.name">INV/2023/0001</span>    
                </center>
            </span>
        </xpath>

        <!-- Our Custom Info Block -->
        <xpath expr="//div[@id='informations']" position="replace">
            <div class="row mb-4" name="invoice_to_block" style="margin-bottom: 10px;">
                <div class="col-6 o_invoice_to_block">
                    <div class="o_invoice_to_label">Invoice to:</div>
                    <div class="o_invoice_to_name"><span t-field="o.partner_id.name"/></div>
                    <div class="o_invoice_to_contact">
                        <t t-if="o.partner_id.phone">
                            <span class="o_invoice_to_phone">Tel: <span t-field="o.partner_id.phone"/></span>
                        </t>
                        <t t-if="o.partner_id.phone and o.partner_id.mobile"> | </t>
                        <t t-if="o.partner_id.mobile">
                            <span class="o_invoice_to_mobile">Mobile: <span t-field="o.partner_id.mobile"/></span>
                        </t>
                    </div>
                </div>
                <div class="col-6 text-end">
                    <strong>Date:</strong>
                    <span t-field="o.invoice_date" t-options="{'format': 'dd-MMM-yy'}"/>
                </div>
            </div>
        </xpath>

        <!-- Jewellery invoice: Type, Karat/Purity and Weight columns (only when needed). -->
        <xpath expr="//th[@name='th_description']" position="after">
            <t t-if="report_show_jewellery_type"><th name="th_jewellery_type" class="text-end"><span>Jewellery Type</span></th></t>
            <t t-if="report_show_karat"><th name="th_karat" class="text-end"><span>Karat/Purity</span></th></t>
            <t t-if="report_show_weight"><th name="th_weight" class="text-end"><span>Weight (g)</span></th></t>
        </xpath>

        <!-- Our custom payment block -->
        <xpath expr="//div[contains(@class, 'ms-auto')]" position="replace">
            <div class="ms-auto">
                <table class="table table-sm table-borderless avoid-page-break-inside">
                    <!-- Custom Total Amount -->
                    <tr class="border-black fw-bold">
                        <td>Total Amount</td>
                        <td class="text-end">
                            <span t-field="o.amount_total"
                                t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                        </td>
                    </tr>
                </table>
            </div>
        </xpath>

        <!-- Add Jewellery cells to each product line (only if column is shown). -->
        <xpath expr="//td[@name='account_invoice_line_name']" position="after">
            <t t-if="report_show_jewellery_type"><td name="td_jewellery_type" class="text-end">
                <span t-if="line.jewellery_type == 'gold_local'">Gold - Local</span>
                <span t-elif="line.jewellery_type == 'gold_foreign'">Gold - Foreign</span>
                <span t-elif="line.jewellery_type == 'gold_bars'">Gold Bars</span>
                <span t-elif="line.jewellery_type == 'diamond_jewellery'">Diamond Jewellery</span>
                <span t-elif="line.jewellery_type == 'silver'">Silver</span>
            </td></t>
            <t t-if="report_show_karat"><td name="td_karat" class="text-end">
                <span t-if="line.gold_purity" t-field="line.gold_purity"/>
                <span t-elif="line.diamond_karat" t-field="line.diamond_karat"/>
                <span t-elif="line.silver_purity" t-field="line.silver_purity"/>
            </td></t>
            <t t-if="report_show_weight"><td name="td_weight" class="text-end">
                <span t-if="line.jewellery_weight_g" t-field="line.jewellery_weight_g"/>
                <span t-elif="line.gold_weight_g" t-field="line.gold_weight_g"/>
            </td></t>
        </xpath>

        
        <!-- Quantity column: show only if at least one product line (header and cell). -->
        <xpath expr="//th[@name='th_quantity']" position="replace">
            <t t-if="report_show_quantity"><th name="th_quantity" class="text-end"><span>Quantity</span></th></t>
        </xpath>
        <xpath expr="//td[@name='td_quantity']" position="replace">
            <t t-if="report_show_quantity"><td name="td_quantity" class="text-end"><span t-field="line.quantity" t-options="{'widget': 'float', 'precision': 0}"/></td></t>
        </xpath>
        <!-- Unit price column: show only when quantity column is shown. Base uses th_priceunit (no underscore). -->
        <xpath expr="//th[@name='th_priceunit']" position="replace">
            <t t-if="report_show_unit_price"><th name="th_priceunit" class="text-end"><span>Unit Price</span></th></t>
        </xpath>
        <xpath expr="//td[@name='td_price_unit']" position="replace">
            <t t-if="report_show_unit_price"><td name="td_price_unit" class="text-end"><span t-field="line.price_unit" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></td></t>
        </xpath>

        <!-- Remove Taxes column from header -->
        <xpath expr="//th[@name='th_taxes']" position="replace"/>

        <!-- Remove Taxes cell and the t-set for taxes from product line -->
        <xpath expr="//td[@name='td_taxes']" position="replace"/>
        <xpath expr="//t[@t-set='taxes'][@t-value]" position="replace"/>
        <!-- Remove Payment Communication block (div containing p name="payment_communication") -->
        <xpath expr="//p[@name='payment_communication']/parent::div" position="replace"/>

        <!-- Custom footer at the very bottom of the invoice body -->
        <xpath expr="//div[contains(@class, 'page') and contains(@class, 'mb-4')]" position="after">
            <!-- Dynamic margin: 500px base for 1 product, minus 50px per additional line -->
            <t t-set="line_count" t-value="len(o.invoice_line_ids)"/>
            <t t-set="footer_margin" t-value="450 - ((line_count - 1) * 50) if (400 - ((line_count - 1) * 50)) &gt; 0 else 0"/>
            <div t-attf-style="border-top: 2px solid #000; padding: 8px 0 0 0; font-size: 10px; color: #555; margin-top: #{footer_margin}px;">
                <div class="row">
                    <div class="col-4 text-start">
                        <strong style="color: #000;">Contact Us</strong><br/>
                        Tel: (+2)01000 226 992
                    </div>
                    <div class="col-4 text-center">
                        <strong style="color: #000;">Marjaan Jewellery</strong><br/>
                        27 Ismael Ramzy St, Heliopolis, Cairo, Egypt
                    </div>
                    <div class="col-4 text-end">
                        <strong style="color: #000;">Terms &amp; Conditions</strong><br/>
                        Info@Marjaanjewellery.com<br/>
                        www.marjaanjewellery.com
                    </div>
                </div>
            </div>
        </xpath>
    </template>
</odoo>
